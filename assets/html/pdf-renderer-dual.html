<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Reader</title>
    <link rel="stylesheet" href="/assets/css/variable.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="shortcut icon" href="/logos/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather&display=swap" rel="stylesheet">
</head>
<body class="day-theme">

<script type="module" src="/assets/js/cookie.js"></script>
<script type="module" src="/assets/js/lang.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<div class="topnav" style="text-align: center;">
    <img src="/logos/default-bear.gif" width="25" height="25" style="vertical-align: middle; display: inline-block;"> 
    <a href="/index.html" id="home"> 
        <span class="eng">Bear Resort</span><span class="chn">小熊樂园</span>
    </a> &nbsp; &nbsp; &nbsp; &nbsp; 
    <span class="eng">PDF Reader</span><span class="chn">PDF 阅读器</span> 
</div>

<div id="content" style="text-align: left;">
    <a href="/assets/html/login.html" id="login">Log in</a>

    <br><br><br>

    <div style="text-align: center;">
        <div id="pdf-controls" style="text-align: center; margin-bottom: 10px;">
            <button onclick="prevPage()">←</button>
            <span><span class="eng">Page</span><span class="chn">页码</span>: <span id="page-num">1</span> / <span id="page-count">?</span></span>
            <button onclick="nextPage()">→</button>
        </div>

        <div id="loading" style="text-align: center;">
            <span class="eng">Loading...</span><span class="chn">加载中...</span>
        </div>

        <!-- Two canvas elements for rendering the PDFs -->
        <div id="canvasContainer" style="text-align: center;">
            <canvas id="pdf-render-top" style="width: 75%; height: auto; border: 1px solid #ccc;" class="eng"></canvas>
            <canvas id="pdf-render-bottom" style="width: 75%; height: auto; border: 1px solid #ccc;" class="chn"></canvas>
        </div>
    </div>
    <br><br><br>
</div>

<div id="lang">Eng</div>
<div id="day-night">🌞</div>

<div class="botnav" style="text-align: center;">
    <span class="eng">When you finish, please close the page.</span><span class="chn">当你用完本界面，请直接关闭界面。</span>
</div>

<script src="/assets/js/link.js"></script>
<script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const url1 = urlParams.get('pdf'); // First PDF
    const url2 = urlParams.get('pdfChn'); // Second PDF

    const canvasTop = document.getElementById('pdf-render-top');
    const ctxTop = canvasTop.getContext('2d');
    const canvasBottom = document.getElementById('pdf-render-bottom');
    const ctxBottom = canvasBottom.getContext('2d');
    const loadingMsg = document.getElementById('loading');

    if (!url1 || !url2) {
        loadingMsg.textContent = "Invalid URL.";
    }

    let pdfDoc1 = null;
    let pdfDoc2 = null;
    let pageNum = 1;
    let pageCount1 = 0;
    let pageCount2 = 0;
    const scale = 5.0;

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    function renderPage(num) {
        loadingMsg.style.display = 'block';

        // Render first PDF
        pdfDoc1.getPage(num).then(page => {
            const viewport = page.getViewport({ scale: scale });
            canvasTop.height = viewport.height;
            canvasTop.width = viewport.width;

            const renderContext = {
                canvasContext: ctxTop,
                viewport: viewport
            };

            page.render(renderContext).promise.then(() => {
                document.getElementById('page-num').textContent = pageNum;
            });
        });

        // Render second PDF
        pdfDoc2.getPage(num).then(page => {
            const viewport = page.getViewport({ scale: scale });
            canvasBottom.height = viewport.height;
            canvasBottom.width = viewport.width;

            const renderContext = {
                canvasContext: ctxBottom,
                viewport: viewport
            };

            page.render(renderContext).promise.then(() => {
                loadingMsg.style.display = 'none';
                document.getElementById('page-count').textContent = Math.max(pageCount1, pageCount2);
            });
        });
    }

    function queueRenderPage(num) {
        if (num >= 1 && num <= Math.min(pageCount1, pageCount2)) {
            pageNum = num;
            renderPage(pageNum);
        }
    }

    function nextPage() {
        if (pageNum < Math.min(pageCount1, pageCount2)) {
            queueRenderPage(pageNum + 1);
        }
    }

    function prevPage() {
        if (pageNum > 1) {
            queueRenderPage(pageNum - 1);
        }
    }

    // Load the PDFs
    pdfjsLib.getDocument({ url: url1 }).promise.then(doc => {
        pdfDoc1 = doc;
        pageCount1 = doc.numPages;
        if (pdfDoc2) {
            renderPage(pageNum);
        }
    }).catch(err => {
        console.error("PDF load error 1:", err);
        loadingMsg.textContent = "Failed to load the first PDF. Refresh or try again.";
    });

    pdfjsLib.getDocument({ url: url2 }).promise.then(doc => {
        pdfDoc2 = doc;
        pageCount2 = doc.numPages;
        if (pdfDoc1) {
            renderPage(pageNum);
        }
    }).catch(err => {
        console.error("PDF load error 2:", err);
        loadingMsg.textContent = "Failed to load the second PDF. Refresh or try again.";
    });
</script>

<script src="/assets/js/listener.js"></script>

<style>
    img {
        max-width: 75%;
        height: auto;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }
    #pdf-render, #pdf-render-top, #pdf-render-bottom {
        max-width: 100%;
        height: auto;
        border: 1px solid #ccc;
    }
    #pdf-controls button {
        padding: 5px 10px;
        margin: 0 5px;
        font-size: 12px;
    }
</style>

</body>
</html>