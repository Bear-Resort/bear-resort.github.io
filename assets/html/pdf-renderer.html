---
layout: page
---

<style>
  img {
    max-width: 100%;
    height: auto;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }
</style>

<script>
  import { updateMyLanguage } from '/assets/js/lang.js';
  function renderPage() {
    tn = document.getElementById("topnav");
    bn = document.getElementById("botnav");

    tn.innerHTML = `<img src="/logos/default-bear.gif" width="25" height="25" style="vertical-align: middle; display: inline-block;"> <a href="/index.html" id="home"> <span class="eng">Bear Resort</span><span class="chn">小熊樂園</span></a> &nbsp; &nbsp; &nbsp; &nbsp;
    <span class="eng">PDF Reader</span><span class="chn">PDF 阅读器</span>`;

    bn.innerHTML = `<span class="eng">When you are finished, you can just close the page.</span> <span class="chn">当你用完本界面，请直接关闭界面。</span>`;
  }

  document.addEventListener("DOMContentLoaded", () => {
    renderPage();
    updateMyLanguage();
  })
</script>

<div style="text-align: center;">
  <div id="pdf-controls" style="text-align: center; margin-bottom: 10px;">
    <button onclick="prevPage()" id="prev">←</button>
    <span><span class="eng">Page</span><span class="chn">页码</span>: <input type="number" id="page-num" placeholder="1" min="1" style="width: 25pt;"> / <span id="page-count">?</span></span>
    <button onclick="nextPage()" id="next">→</button>
  </div>

  <div id="loading" style="text-align: center;"><span class="eng">Loading...</span><span class="chn">加载中...</span></div>
  <div id="pdf-viewer-container" style="text-align: center;">
    <canvas id="pdf-render" style="width: 75%; height: auto; border: 1px solid #ccc;"></canvas>
    <div class="textLayer"></div>
  </div>
</div>
      
<script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const url = urlParams.get('pdf');

  const pdfContainer = document.getElementById("pdf-viewer-container");
  const canvas = document.getElementById('pdf-render');
  const textLayerDiv = document.querySelector('.textLayer');
  const ctx = canvas.getContext('2d');
  const loadingMsg = document.getElementById('loading');

  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');


  if (!url) {
    loadingMsg.textContent = "Invalid URL.";
  }

  let pdfDoc = null;
  let pageNum = Number(localStorage.getItem("page")) ?? 1;
  let pageCount = 0;
  let scale = 5;

  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  document.getElementById('page-num').addEventListener("keydown", (event) => {
    if (event.key !== "Enter") {
      return;
    }
    const number = document.getElementById('page-num').value;
    renderPage(number);
  });

  function checkPage() {
    nextBtn.disabled = pageNum >= pageCount;
    prevBtn.disabled = pageNum <= 1;
  }

  function getResponsiveScale(originalPdfWidth) {
    const container = document.getElementById('pdf-viewer-container');
    const containerWidth = container.offsetWidth;
    return containerWidth / originalPdfWidth;
  }

  function renderPage(num) {
  pageNum = num % pageCount;
  if (pageNum <= 0) {
    pageNum += pageCount;
  }
  localStorage.setItem(`page-${url}`, pageNum.toString());
  loadingMsg.style.display = "block";

  pdfDoc.getPage(num).then((page) => {
    let unscaledViewport = page.getViewport({ scale: 1 });
    let scale = getResponsiveScale(unscaledViewport.width);

    const viewport = page.getViewport({ scale: scale });
    const imgviewport = page.getViewport({ scale: scale * 3 });
    const textviewport = page.getViewport({ scale: scale });

    canvas.width = viewport.width * 3;
    canvas.height = viewport.height * 3;
    canvas.style.width = viewport.width + "px";
    canvas.style.height = viewport.height + "px";

    textLayerDiv.innerHTML = "";
    textLayerDiv.style.width = viewport.width + "px";
    textLayerDiv.style.height = viewport.height + "px";
    textLayerDiv.style.position = "absolute";
    textLayerDiv.style.top = "0";
    textLayerDiv.style.left = "0";
    textLayerDiv.style.setProperty('--scale-factor', viewport.scale);

    const renderContext = {
      canvasContext: ctx,
      viewport: imgviewport,
    };

    page.render(renderContext).promise.then(() => {
      loadingMsg.style.display = "none";
      pageNumDisplay.value = pageNum;
      textLayerDiv.innerHTML = "";
      checkPage();
      page.getTextContent().then(textContent => {
        pdfjsLib.renderTextLayer({
          textContent: textContent,
          container: textLayerDiv,
          viewport: textviewport,
          textDivs: [],
        });
      });
    });
  });
}

window.addEventListener('resize', () => {
    if (pdfDoc) renderPage(pageNum);
});

  // function renderPage(num) {
  //   pageNum = num % pageCount;
  //   if (pageNum <= 0) {
  //     pageNum += pageCount;
  //   }
  //   localStorage.setItem("page", pageNum.toString());

  //   loadingMsg.style.display = 'block';

  //   pdfDoc.getPage(pageNum).then(page => {
  //     const viewport = page.getViewport({ scale: scale });
  //     canvas.height = viewport.height;
  //     canvas.width = viewport.width;

  //     const renderContext = {
  //       canvasContext: ctx,
  //       viewport: viewport
  //     };

  //     page.render(renderContext).promise.then(() => {
  //       loadingMsg.style.display = 'none';
  //       checkPage();
  //       document.getElementById('page-num').value = pageNum;
  //       textLayerDiv.innerHTML = "";
        
  //       page.getTextContent().then( textContent => {
  //         pdfjsLib.renderTextLayer({
  //               textContent: textContent,
  //               container: textLayerDiv,
  //               viewport: viewport,
  //               textDivs: []
  //           });
  //         textLayerDiv.style.width = `${canvas.width / 4}px`;
  //         textLayerDiv.style.height = `${canvas.height / 4}px`;
  //       })
  //     });
  //   });
  // }

  function queueRenderPage(num) {
    if (num >= 1 && num <= pageCount) {
      pageNum = num;
      renderPage(pageNum);
    }
  }

  function nextPage() {
    if (pageNum < pageCount) {
      queueRenderPage(pageNum + 1);
    }
  }

  function prevPage() {
    if (pageNum > 1) {
      queueRenderPage(pageNum - 1);
    }
  }

  // Load the PDF
  pdfjsLib.getDocument({
    url: url,
  }).promise.then(doc => {
    pdfDoc = doc;
    pageCount = doc.numPages;
    document.getElementById('page-count').textContent = pageCount;
    renderPage(pageNum);
  }).catch(err => {
    console.error("PDF load error:", err);
    loadingMsg.textContent = "Failed to load PDF. Refresh or try logging in.";
  });
</script>

<script src="/assets/js/listener.js"></script>


  <style>
    img {
      max-width: 75%;
      height: auto;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
  #pdf-render {
    max-width: 100%;
    height: auto;
    border: 1px solid #ccc;
  }
  #pdf-controls button {
    padding: 5px 10px;
    margin: 0 5px;
    font-size: 12px;
  }
</style>

  </style>

</body>
</html>